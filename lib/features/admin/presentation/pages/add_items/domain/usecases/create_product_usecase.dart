import '../entities/product.dart';
import '../repositories/product_repository.dart';
import '../../../../../../../core/base/base_usecase.dart';
import '../../../../../../../core/error/failures.dart';
import 'package:dartz/dartz.dart';

/// ğŸŸ¦ CreateProductUseCase - Ù…Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø§Ù„ÙˆØ§Ø­Ø¯Ø© (SRP)
/// Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙ‚Ø· - Ù„Ø§ ÙŠØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
///
/// ğŸŸ¦ Ù…Ø¨Ø¯Ø£ Ù‚Ù„Ø¨ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª (DIP)
/// ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ abstractions ÙˆÙ„ÙŠØ³ implementations
class CreateProductUseCase extends BaseUseCase<Product, Product> {
  final ProductRepository repository;

  CreateProductUseCase({required this.repository});

  @override
  Future<Either<Failure, Product>> call(Product product) async {
    try {
      // âœ… 1. Business validation only
      final validationResult = _validateProduct(product);
      return validationResult.fold((failure) => Left(failure), (_) async {
        // âœ… 2. Save product directly - no data transformation
        return await repository.createProduct(product);
      });
    } catch (e) {
      return Left(ServerFailure(message: 'Failed to create product: $e'));
    }
  }

  // âœ… Business validation ÙÙŠ UseCase ÙÙ‚Ø·
  Either<Failure, void> _validateProduct(Product product) {
    final errors = <String>[];

    if (product.name.isEmpty) {
      errors.add('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø·Ù„ÙˆØ¨');
    }

    if (product.nameAr.isEmpty) {
      errors.add('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù…Ø·Ù„ÙˆØ¨');
    }

    if (product.price <= 0) {
      errors.add('Ø§Ù„Ø³Ø¹Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±');
    }

    if (product.mainCategoryId <= 0) {
      errors.add('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ©');
    }

    // âœ… Additional business validations
    if (product.name.length < 2) {
      errors.add('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ«Ø± Ù…Ù† Ø­Ø±ÙÙŠÙ†');
    }

    if (product.nameAr.length < 2) {
      errors.add('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ«Ø± Ù…Ù† Ø­Ø±ÙÙŠÙ†');
    }

    if (product.price > 1000) {
      errors.add('Ø§Ù„Ø³Ø¹Ø± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 1000');
    }

    if (product.preparationTime != null && product.preparationTime! < 0) {
      errors.add('ÙˆÙ‚Øª Ø§Ù„ØªØ­Ø¶ÙŠØ± ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬Ø¨');
    }

    if (product.sortOrder != null && product.sortOrder! < 0) {
      errors.add('ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬Ø¨');
    }

    if (errors.isNotEmpty) {
      return Left(ServerFailure(message: errors.join(', ')));
    }

    return const Right(null);
  }
}
